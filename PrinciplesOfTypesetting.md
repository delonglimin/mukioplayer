# MukioPlayer对普通弹幕的排版算法原则 #

普通弹幕意指顶部,底部,及向左滚动字幕.它们如何在视频播放时展示应该是弹幕播放器的基础.
根据人类的阅读习惯总结出的几个原则,作为MukioPlayer弹幕排版的基础.


因为弹幕数据的存储是结构化的,所以在播放时不必对弹幕进行语法处理,这与ass不同.从模型上看,屏幕的长方面与总播放时间构成了一个视频长方体,弹幕在这个模型中是一个个平行六面体,其中静态弹幕是长方体.视频长方体的每个水平切面就是一个个视频画面.所以弹幕的排版问题就是一个个小的平行六面体在一个大的长方体内的排布问题.因为只要处理好每一时刻的弹幕,立体模型也自然成定局,问题又归结为在一个时间点上,在视频长方面上对弹幕的小长方形的排布.排布策略可以随意确定.通过对平时视频字幕的理解以及对已有的弹幕播放器的体验,MukioPlayer使用以下三个原则:

  * (一)底部字幕尽量向底部聚集,但不重叠,顶部字幕,滚动字幕尽量向顶部聚集,但不重叠
  * (二)当一个视频平面用尽,则再虚拟一个逻辑视频平面,弹幕在新的视频平面上排布,遵行(一),在实际显示时,各个逻辑空间依次画到视频面上.(所以实际上弹幕是会重叠的)
  * (三)不同种类的字幕,在不同的逻辑视频平面上排布(所以即使弹幕很稀疏,顶部字幕也可能与滚动字幕重叠)

具体的算法在CommentViewManager中实现.

事实上以底部字幕排版为基础,顶部字幕的排版只要加个纵坐标的转换即可,而滚动字幕,则再加上水平方向上的原则(一)的检验,即在弹幕生命周期内不与现有的同一视频平面上的弹幕重叠.

而底部字幕的排版,实际上就是一维空间的管理和分配问题,保证空间不冲突的情况下尽量在低坐标处分配空间.